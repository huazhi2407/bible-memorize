/**
 * 同音字群組（經文／口語常見）
 * 同一組在準確率計算時視為正確，並可依參考經文自動修正顯示
 */
const GROUPS = [
  ['他', '她', '它', '祂'],
  ['的', '得', '地'],
  ['是', '事', '世', '市', '示', '視'],
  ['在', '再'],
  ['經', '精', '京', '驚'],
  ['主', '住', '注', '助'],
  ['道', '到', '倒'],
  ['心', '新', '信'],
  ['生', '聲', '升', '聖'],
  ['因', '音', '恩'],
  ['裡', '理', '禮', '李'],
  ['與', '於', '予', '雨'],
  ['為', '位', '未', '味', '衛'],
  ['從', '重', '眾'],
  ['和', '何', '合', '河'],
  ['見', '件', '建', '健', '劍'],
  ['時', '十', '石', '食', '實', '識'],
  ['這', '著', '者'],
  ['那', '拿', '哪'],
  ['有', '又', '由', '友', '右'],
  ['都', '督', '讀'],
  ['要', '藥', '耀'],
  ['就', '救', '舊', '舅'],
  ['會', '回', '惠', '匯', '繪'],
  ['對', '隊', '待'],
  ['但', '淡', '彈', '誕'],
  ['只', '知', '之', '支', '枝', '止', '指', '紙', '志'],
  ['以', '已', '意', '義', '易', '一'],
  ['向', '像', '相', '香', '鄉'],
  ['成', '城', '誠', '承', '程'],
  ['天', '田', '添', '甜'],
  ['人', '仁', '任', '認'],
  ['神', '什', '審', '沈'],
  ['子', '字', '自', '紫', '資'],
  ['父', '夫', '負', '富', '副'],
  ['名', '明', '命', '鳴'],
  ['光', '廣', '逛'],
  ['靈', '零', '齡', '鈴', '陵'],
  ['賜', '四', '思', '斯', '私', '司'],
  ['叫', '教', '較', '交', '角'],
  ['望', '忘', '妄', '旺'],
  ['願', '原', '元', '園', '緣', '遠'],
  ['榮', '容', '融', '溶', '戎'],
  ['阿', '啊', '亞'],
  ['們', '門', '悶'],
  ['禱', '島', '倒', '導', '道'],
  ['求', '球', '秋', '仇', '囚'],
  ['王', '往', '望', '忘', '妄', '旺'],
  ['權', '全', '泉', '拳', '勸'],
  ['福', '服', '富', '復', '幅'],
  ['義', '以', '已', '意', '易', '一', '醫', '益', '憶'],
  ['恩', '因', '音'],
  ['憐', '連', '聯', '蓮', '廉'],
  ['地', '的', '得'],
  ['行', '形', '型', '興', '星', '幸'],
  ['作', '做', '坐', '座', '左'],
  ['國', '果', '過', '裹'],
  ['民', '敏', '憫', '閩'],
  ['聽', '廳', '庭', '停', '廷'],
  ['稱', '成', '城', '誠', '承', '程', '乘'],
  ['受', '手', '首', '守', '壽', '獸', '售'],
  ['給', '己', '幾', '機', '基', '積', '激', '績', '雞', '及', '極', '吉'],
  ['捨', '社', '設', '射', '蛇', '舌'],
  ['得', '的', '地'],
  ['失', '師', '詩', '施', '石', '時', '十', '食', '識', '實'],
  ['聖', '生', '聲', '升', '勝', '省'],
  ['復', '福', '服', '富', '幅', '父', '負', '副'],
  ['活', '火', '伙', '或', '貨'],
  ['頌', '送', '宋', '鬆', '誦'],
  ['謝', '寫', '泄', '卸', '蟹', '屑'],
  ['讚', '暫', '贊', '站', '戰', '佔', '綻'],
  ['美', '每', '沒', '梅', '煤', '妹'],
  ['耀', '要', '藥', '搖', '遙', '窯', '謠'],
  ['歸', '規', '貴', '鬼', '桂', '跪', '櫃'],
];

/** 字 -> 該字所屬同音群組（Set） */
const charToGroup = new Map();
for (const group of GROUPS) {
  const set = new Set(group);
  for (const ch of group) {
    charToGroup.set(ch, set);
  }
}

export function isHomophone(a, b) {
  if (a === b) return true;
  const g = charToGroup.get(a);
  return g ? g.has(b) : false;
}

/**
 * 依參考經文修正辨識結果中的同音字（僅在「同音」時替換為參考字）
 * 回傳修正後的辨識文字（正規化後對齊長度，再還原為字串；標點不還原）
 */
export function correctHomophones(recognized, reference) {
  const ra = normalizeForCompare(recognized);
  const rb = normalizeForCompare(reference);
  if (ra.length === 0 || rb.length === 0) return recognized;

  const out = [];
  const len = Math.min(ra.length, rb.length);
  for (let i = 0; i < len; i++) {
    out.push(isHomophone(ra[i], rb[i]) ? rb[i] : ra[i]);
  }
  for (let i = len; i < ra.length; i++) {
    out.push(ra[i]);
  }
  return out.join('');
}

function normalizeForCompare(str) {
  return (str || '')
    .replace(/\s+/g, '')
    .replace(/[，。、；：？！「」『』（）\s]/g, '')
    .split('');
}
